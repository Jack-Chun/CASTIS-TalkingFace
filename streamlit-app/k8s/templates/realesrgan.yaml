apiVersion: v1
kind: Pod
metadata:
  name: ${POD_NAME}
  labels:
    app: gpu-model-runner
    model: realesrgan
    job-id: ${JOB_ID}
spec:
  restartPolicy: Never
  volumes:
    - name: my-volume
      persistentVolumeClaim:
        claimName: persistent-volume
  terminationGracePeriodSeconds: 1
  containers:
    - name: gpu-worker
      image: sgs-registry.snucse.org/ws-7l3atgjy3al41/svfr-base:latest
      env:
        - name: HOME
          value: /data
        - name: PATH
          value: /data/python/bin:/data/realesrgan-venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        - name: CUDA_VISIBLE_DEVICES
          value: "0"
      command:
        - /bin/bash
        - -c
        - |
          source /data/realesrgan-venv/bin/activate

          INPUT_VIDEO="${INPUT_VIDEO}"
          OUTPUT_VIDEO="${OUTPUT_VIDEO}"
          SCALE=${SCALE}
          OUTPUT_DIR=$(dirname "${OUTPUT_VIDEO}")
          OUTPUT_BASENAME=$(basename "${OUTPUT_VIDEO}" .mp4)

          mkdir -p "${OUTPUT_DIR}"

          echo "=== Real-ESRGAN Video Upscaling ==="
          echo "Input: ${INPUT_VIDEO}"
          echo "Output: ${OUTPUT_VIDEO}"
          echo "Scale: ${SCALE}x"

          # Get input video info
          echo "Input video info:"
          ffprobe -v error -select_streams v:0 -show_entries stream=width,height,r_frame_rate,duration -of default=noprint_wrappers=1 "${INPUT_VIDEO}"

          # Use the dedicated video inference script
          # This handles frame extraction, processing, and reassembly automatically
          # with proper framerate preservation and audio sync
          cd /data/Real-ESRGAN
          python inference_realesrgan_video.py \
            -i "${INPUT_VIDEO}" \
            -o "${OUTPUT_DIR}" \
            -n RealESRGAN_x${SCALE}plus \
            -s ${SCALE} \
            --suffix "${OUTPUT_BASENAME}" \
            ${FP32_FLAG}

          # The output file is named: {input_basename}_{suffix}.mp4
          INPUT_BASENAME=$(basename "${INPUT_VIDEO}" .mp4)
          GENERATED_OUTPUT="${OUTPUT_DIR}/${INPUT_BASENAME}_${OUTPUT_BASENAME}.mp4"

          # Rename to expected output path if different
          if [ -f "${GENERATED_OUTPUT}" ] && [ "${GENERATED_OUTPUT}" != "${OUTPUT_VIDEO}" ]; then
            mv "${GENERATED_OUTPUT}" "${OUTPUT_VIDEO}"
          fi

          # Verify output exists
          if [ ! -f "${OUTPUT_VIDEO}" ]; then
            echo "ERROR: Output video not created!"
            # List what was created in output dir
            echo "Files in output directory:"
            ls -la "${OUTPUT_DIR}/"
            exit 1
          fi

          # Get output video info
          echo "=== Video upscaling complete! ==="
          echo "Output video info:"
          ffprobe -v error -select_streams v:0 -show_entries stream=width,height,r_frame_rate,duration -of default=noprint_wrappers=1 "${OUTPUT_VIDEO}"
          echo "Output file: ${OUTPUT_VIDEO}"
          ls -lh "${OUTPUT_VIDEO}"

          echo "DONE"
      resources:
        limits:
          nvidia.com/gpu: 1
      volumeMounts:
        - name: my-volume
          mountPath: /data
